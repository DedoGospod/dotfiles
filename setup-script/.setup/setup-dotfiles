#!/usr/bin/env bash

# Colors for logging
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Helper Functions
header() { echo -e "\n${BLUE}==== $1 ====${NC}"; }
log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }

log_task() { echo -ne "${GREEN}[INFO]${NC} $1... "; }
ok() { echo -e "${GREEN}Done.${NC}"; }
fail() { echo -e "${RED}Failed.${NC}"; }

# Faster check for empty directories
is_dir_empty() {
    local dir="$1"
    [[ ! -d "$dir" ]] && return 0
    (shopt -s dotglob; set -- "$dir"/*; [[ ! -e "$1" ]])
}

sync_assets() {
    local src_dir="$1"
    local target_dir="$2"
    local mode="${3:-644}"

    [[ -d "$src_dir" ]] || return
    if is_dir_empty "$src_dir"; then
        warn "Source $src_dir is empty, skipping."
        return
    fi

    sudo mkdir -p "$target_dir"

    if command -v rsync &>/dev/null; then
        log_task "Syncing $target_dir"
        if sudo rsync -a --no-owner --no-group --no-perms \
            --chmod="$mode" --chown=root:root \
            "$src_dir/" "$target_dir/"; then
            ok
        else
            fail
            return 1
        fi
    fi
}

sync_root_tree() {
    local src_root="$1"
    
    if [[ ! -d "$src_root" ]] || is_dir_empty "$src_root"; then
        warn "Source $src_root is empty or missing, skipping."
        return
    fi

    command -v rsync >/dev/null || { error "rsync not available"; exit 1; }

    for top_dir in "$src_root"/*; do
        [[ -d "$top_dir" ]] || continue
        
        local parent_name
        parent_name=$(basename "$top_dir") # e.g., "etc"

        for config_item in "$top_dir"/*; do
            [[ -e "$config_item" ]] || continue
            
            local config_name
            config_name=$(basename "$config_item")
            
            log_task "Syncing /$parent_name/$config_name"
            
            if sudo rsync -a --no-owner --no-group --no-perms \
                --chown=root:root \
                --chmod=Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r \
                "$config_item" "/$parent_name/"; then
                ok
            else
                fail
            fi
        done
    done
}

# Stow Packages
STOW_FOLDERS=(
    backgrounds kwalletrc fastfetch wayland-pipewire-idle-inhibit hypr kitty
    mpv nvim starship swaync waybar wofi yazi zsh tmux uwsm systemd-user scopebuddy
    mangohud scripts
)

# Dotfiles
DOTFILES_DIR="$HOME/dotfiles"
header "DOTFILE CONFIGURATION"

if [[ -d "$DOTFILES_DIR" ]]; then
    log "Stowing dotfiles..."
    cd "$DOTFILES_DIR" || { error "Cannot enter $DOTFILES_DIR"; exit 1; }

    for folder in "${STOW_FOLDERS[@]}"; do
        if [[ -d "$folder" ]]; then
            log_task "Stowing $folder"
            if stow -t "$HOME" --restow "$folder"; then ok; else fail; fi
        else
            warn "Skipping $folder (not found)."
        fi
    done

    # Sync System Binaries (Executables) and Libraries (Data/Dependencies)
    header "SYNCING SYSTEM BINARIES & LIBRARIES"
    sync_assets "$DOTFILES_DIR/scripts/usr/local/bin" "/usr/local/bin" "755"
    sync_assets "$DOTFILES_DIR/scripts/usr/local/lib" "/usr/local/lib" "644"

    # Sync Configuration Files (system-files tree)
    header "SYNCING CONFIGURATION FILES"
    sync_root_tree "$DOTFILES_DIR/root"
fi
