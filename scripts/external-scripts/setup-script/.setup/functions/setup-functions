#!/usr/bin/env bash
# Note: This file relies on variables and functions defined in the main script.

# Colors for logging
readonly GREEN='\033[0;32m'
readonly YELLOW='\033[1;33m'
readonly RED='\033[0;31m'
readonly BLUE='\033[0;34m'
readonly NC='\033[0m'

# Helper Functions
header()  { printf "\n${BLUE}==== %s ====${NC}\n" "$1"; }
log()     { printf "${GREEN}[INFO]${NC} %s\n" "$1"; }
warn()    { printf "${YELLOW}[WARN]${NC} %s\n" "$1"; }
error()   { printf "${RED}[ERROR]${NC} %s\n" "$1"; }
success() { printf "${GREEN}[SUCCESS]${NC} %s\n" "$1"; }

log_task() { printf "${GREEN}[INFO]${NC} %s... " "$1"; }
ok()   { printf "${GREEN}%s${NC}\n" "Done."; }
fail() { printf "${RED}%s${NC}\n" "Failed."; }

# Find the script directory
SCRIPT_DIR="$HOME/dotfiles/scripts/external-scripts/setup-script/.setup"

check_if_root() {
    if [[ "$EUID" -eq 0 ]]; then
        error "Please do not run this script as root."
        error "Run it as a normal user. You will be prompted for sudo password when needed."
        exit 1
    fi
}

prepare_setup_scripts() {
    header "SYSTEM PREPARATION"

    if [[ -d "$SCRIPT_DIR" ]]; then
        for file in "$SCRIPT_DIR"/*; do
            if [[ -f "$file" ]] && [[ "$(basename "$file")" != "package-list" ]] && [[ "$(basename "$file")" != "install-phase" ]]; then
                chmod 755 "$file"
            fi
        done
        log_task "Permissions updated for setup scripts"
        ok
    else
        fail
        error "Directory $SCRIPT_DIR not found!"
        exit 1
    fi
}

import_package_list() {
    PACKAGE_LIST="$SCRIPT_DIR/package-list"
    if [[ -f "$PACKAGE_LIST" ]]; then
        # shellcheck source=/dev/null
        source "$PACKAGE_LIST"
        log_task "Package lists loaded."
        ok
    else
        fail
        error "package-list not found!"
        exit 1
    fi
}

ask() {
    read -rp "$(echo -e "  ${YELLOW}??${NC} $1 (y/N): ")" response
    [[ "$response" =~ ^[Yy]$ ]]
}

import_install_phase() {
    INSTALL_PHASE="$SCRIPT_DIR/install-phase"
    if [[ -f "$INSTALL_PHASE" ]]; then
        # shellcheck source=/dev/null
        source "$INSTALL_PHASE"
    else
        error "install-phase script not found at $INSTALL_PHASE"
        exit 1
    fi
}

run_setup_script() {
    local script_name="$1"
    local script_path="$SCRIPT_DIR/$script_name"

    if [[ -f "$script_path" ]]; then
        bash "$script_path"
    else
        error "Could not find $script_name"
    fi
}



is_reboot_required() {
    if [[ -f /tmp/reboot_required ]]; then
        rm /tmp/reboot_required
        if ask "System changes detected. Reboot now?"; then
            log "Rebooting..."
            sudo reboot
        else
            warn "Please reboot manually to apply changes."
        fi
    else
        log "No system changes required a reboot. Enjoy!"
    fi
}
