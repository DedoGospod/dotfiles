#!/usr/bin/env bash

# Colors for logging
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Helper Functions
header() { echo -e "\n${BLUE}==== $1 ====${NC}"; }
log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }

log_task() { echo -ne "${GREEN}[INFO]${NC} $1... "; }
ok() { echo -e "${GREEN}Done.${NC}"; }
fail() { echo -e "${RED}Failed.${NC}"; }

# Global rsync defaults for system files
RSYNC_BASE_OPTS=(-a --no-owner --no-group --no-perms --chown=root:root)

# Fast check for empty directories
is_dir_empty() {
    [[ ! -d "$1" ]] && return 0
    [[ -z $(find "$1" -mindepth 1 -print -quit) ]]
}

sync_assets() {
    local src="$1" target="$2" mode="${3:-644}"
    
    [[ ! -d "$src" ]] && return
    is_dir_empty "$src" && { warn "Source $src is empty, skipping."; return; }

    log_task "Syncing $target"
    sudo mkdir -p "$target"
    
    if sudo rsync "${RSYNC_BASE_OPTS[@]}" --chmod="$mode" "$src/" "$target/"; then
        ok
    else
        fail
    fi
}

sync_root_tree() {
    local src_root="$1"
    local root_perms="Du=rwx,Dg=rx,Do=rx,Fu=rw,Fg=r,Fo=r"

    if [[ ! -d "$src_root" ]] || is_dir_empty "$src_root"; then
        warn "Root $src_root missing/empty."
        exit 1
    fi

    # Iterate through top-level dirs (e.g., etc, usr)
    for top_dir in "$src_root"/*; do
        [[ -d "$top_dir" ]] || continue
        
        local parent
        parent=$(basename "$top_dir")

        # Iterate through actual config items (e.g., etc/snapper, etc/pacman.d)
        for item in "$top_dir"/*; do
            [[ -e "$item" ]] || continue
            
            local child
            child=$(basename "$item")
            
            # This gives you the "/etc/snapper" style output
            log_task "Syncing /$parent/$child"
            
            # Sync to the corresponding system path (e.g., /etc/)
            if sudo rsync "${RSYNC_BASE_OPTS[@]}" --chmod="$root_perms" "$item" "/$parent/"; then
                ok
            else
                fail
            fi
        done
    done
}

# Stow Packages
STOW_FOLDERS=(
    backgrounds kwalletrc fastfetch wayland-pipewire-idle-inhibit hypr kitty
    mpv nvim starship swaync waybar wofi yazi zsh tmux uwsm systemd-user scopebuddy
    mangohud
)

# Dotfiles
DOTFILES_DIR="$HOME/dotfiles"
header "DOTFILE CONFIGURATION"

if [[ -d "$DOTFILES_DIR" ]]; then
    log "Stowing dotfiles..."
    cd "$DOTFILES_DIR" || { error "Cannot enter $DOTFILES_DIR"; exit 1; }

    if [[ -d "scripts/user-scripts" ]]; then
        log_task "Stowing user scripts"
        if stow -d "scripts" -t "$HOME" --restow user-scripts; then ok; else fail; fi
    fi

    for folder in "${STOW_FOLDERS[@]}"; do
        if [[ -d "$folder" ]]; then
            log_task "Stowing $folder"
            if stow -t "$HOME" --restow "$folder"; then ok; else fail; fi
        else
            warn "Skipping $folder (not found)."
        fi
    done

    # Sync System Binaries (Executables) and Libraries (Data/Dependencies)
    header "SYNCING SYSTEM BINARIES & LIBRARIES"
    sync_assets "$DOTFILES_DIR/scripts/system-scripts/usr/local/bin" "/usr/local/bin" "755"
    sync_assets "$DOTFILES_DIR/scripts/system-scripts/usr/local/lib" "/usr/local/lib" "755"

    # Sync Configuration Files (system-files tree)
    header "SYNCING CONFIGURATION FILES"
    sync_root_tree "$DOTFILES_DIR/root"
fi
