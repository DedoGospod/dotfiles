#!/usr/bin/env bash

# Colors for logging
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Helper Functions
header() { echo -e "\n${BLUE}==== $1 ====${NC}"; }
log() { echo -e "${GREEN}[INFO]${NC} $1"; }
warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }

log_task() { echo -ne "${GREEN}[INFO]${NC} $1... "; }
ok() { echo -e "${GREEN}Done.${NC}"; }
fail() { echo -e "${RED}Failed.${NC}"; }

# Global rsync defaults
RSYNC_OPTS=(-rlt --chown=root:root)

sync_root_tree() {
    local src="$1"
    local perms="${2:-D755,F644}"
    
    shopt -s nullglob

    if [[ ! -d "$src" ]] || [[ -z "$(find "$src" -mindepth 1 -maxdepth 1 -print -quit)" ]]; then
        warn "Source $src is invalid or empty."
        return 1
    fi

    for top in "$src"/*/; do
        local parent
        parent=$(basename "$top")
        
        for item in "$top"*; do
            local item_name
            item_name=$(basename "$item")
            
            log_task "Syncing /$parent/$item_name"

            if sudo rsync "${RSYNC_OPTS[@]}" --chmod="$perms" "$item" "/$parent/"; then
                ok
            else
                fail
            fi
        done
    done
    
    shopt -u nullglob
}

# Stow Packages
STOW_FOLDERS=(
    backgrounds kwalletrc fastfetch wayland-pipewire-idle-inhibit hypr kitty
    mpv nvim starship swaync waybar wofi yazi zsh tmux uwsm systemd-user scopebuddy
    mangohud
)

# Dotfiles
DOTFILES_DIR="$HOME/dotfiles"
header "DOTFILE CONFIGURATION"

if [[ -d "$DOTFILES_DIR" ]]; then
    log "Stowing dotfiles..."
    cd "$DOTFILES_DIR" || {
        error "Cannot enter $DOTFILES_DIR"
        exit 1
    }

    if [[ -d "scripts/user-scripts" ]]; then
        log_task "Stowing user scripts"
        if stow -d "scripts" -t "$HOME" --restow user-scripts; then ok; else fail; fi
    fi

    for folder in "${STOW_FOLDERS[@]}"; do
        if [[ -d "$folder" ]]; then
            log_task "Stowing $folder"
            if stow -t "$HOME" --restow "$folder"; then ok; else fail; fi
        else
            warn "Skipping $folder (not found)."
        fi
    done

    # Sync system files
    header "SYNCING FILES"
    sync_root_tree "$DOTFILES_DIR/root"
    sync_root_tree "$DOTFILES_DIR/scripts/system-scripts" "755"
fi
