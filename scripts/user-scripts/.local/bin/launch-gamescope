#!/usr/bin/env bash

set -e

# Default Gamescope options
GAMESCOPE_OPTS=(
    # Display
    --prefer-vk-device 0
    --rt              # Real-time scheduling
    --hdr-enabled     # Enable HDR if available
    --framerate-limit "$(( ${GAMESCOPE_REFRESH:-165} * 2 ))"
    --nested-refresh "${GAMESCOPE_REFRESH:-165}"

    # Mouse settings
    --mouse-sensitivity 1.0
    --force-grab-cursor

    # Performance
    --immediate-flips
    --disable-layers

    # Fullscreen
    --fullscreen
)

# Define your physical monitor resolution
TARGET_W="${GAMESCOPE_WIDTH:-1920}"
TARGET_H="${GAMESCOPE_HEIGHT:-1080}"

# Define the resolution you want to game to produce
INTERNAL_W=2560
INTERNAL_H=1440

GAMESCOPE_OPTS+=(
    -w "$INTERNAL_W"      # Internal Width (High Res)
    -h "$INTERNAL_H"      # Internal Height (High Res)
    -W "$TARGET_W"        # Output Width (Monitor Res)
    -H "$TARGET_H"        # Output Height (Monitor Res)
)

# Check if we are in a Wayland or X11 session (Nested) or a TTY (Embedded)
if [ -z "$DISPLAY" ] && [ -z "$WAYLAND_DISPLAY" ]; then
    echo "Running Embedded gamescope (DRM)"
    exec gamescope --backend drm "${GAMESCOPE_OPTS[@]}" --fullscreen -- steam -gamepadui -steamos3 
else
    echo "Running Nested gamescope"
    exec gamescope "${GAMESCOPE_OPTS[@]}" -- steam -gamepadui -steamos3 
fi
