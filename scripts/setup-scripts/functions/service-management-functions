#!/usr/bin/env bash
# Note: This file contains logic for managing systemd services and system config.

# ==============================================================================
# 1. UI & LOGGING CONFIGURATION
# ==============================================================================

# Colors for logging
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Helper Functions
header()  { echo -e "\n${BLUE}==== $1 ====${NC}"; }
log()     { echo -e "${GREEN}[INFO]${NC} $1"; }
warn()    { echo -e "${YELLOW}[WARN]${NC} $1"; }
error()   { echo -e "${RED}[ERROR]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }

log_task() { echo -ne "${GREEN}[INFO]${NC} $1... "; }
ok()       { echo -e "${GREEN}Done.${NC}"; }
fail()     { echo -e "${RED}Failed.${NC}"; }

# ==============================================================================
# 2. SERVICE CORE FUNCTIONS
# ==============================================================================

# Check if service exists
service_exists() {
    local service="$1"
    local scope_arg="$2"
    local systemctl_args=()
    [[ -n "$scope_arg" ]] && systemctl_args+=("$scope_arg")

    if systemctl "${systemctl_args[@]}" list-unit-files "$service" | grep -q "$service"; then
        return 0
    else
        return 1
    fi
}

# Enable and start services via prompt
manage_service() {
    local service="$1"
    local scope="$2"   # --user or empty for system
    local action="$3"  # enable, disable, restart
    local desc="$4"    # Description for user
    local default="$5" # Y or N

    local scope_label="System"
    [[ "$scope" == "--user" ]] && scope_label="User"

    if ! service_exists "$service" "$scope"; then
        warn "[${scope_label}] Service ${YELLOW}$service${NC} not found. Skipping."
        return
    fi

    local prompt_str="  ${YELLOW}??${NC} Do you want to ${action^^} ${BLUE}$service${NC} ($desc)? "
    [[ "$default" == "Y" ]] && prompt_str+="[Y/n]: " || prompt_str+="[y/N]: "

    read -r -p "$(echo -e "$prompt_str")" choice
    [[ -z "$choice" ]] && choice="$default"

    if [[ "$choice" =~ ^[Yy]$ ]]; then
        if [[ "$scope" == "--user" ]]; then
            systemctl --user "$action" --now "$service"
        else
            sudo systemctl "$action" --now "$service"
        fi
        success "$service ${action}d."
    else
        log "Skipping $service."
    fi
}

# ==============================================================================
# 3. EXCLUSIVE SELECTION & PROCESSING
# ==============================================================================

# Pick which service to use if multiple are in the same category (e.g. multiple notifications)
select_exclusive_service() {
    local category="$1"
    local scope="$2"
    shift 2
    local options=("$@")

    # Check if any of the options are already running
    for srv in "${options[@]}"; do
        if systemctl "$scope" is-active --quiet "$srv"; then
            log "$srv is already active. Skipping $category selection."
            return 0
        fi
    done

    log "Select which service to use for: $category"
    PS3="$(echo -e "${YELLOW}??${NC} Choice (1-${#options[@]} or 's' to skip): ")"

    select opt in "${options[@]}"; do
        if [[ "$REPLY" == "s" ]]; then
            log "Skipping $category configuration."
            break
        elif [[ -n "$opt" ]]; then
            log_task "Setting up $opt"

            # Disable all competing services in the list
            for srv in "${options[@]}"; do
                if [[ "$scope" == "--user" ]]; then
                    systemctl --user disable --now "$srv" >/dev/null 2>&1 || true
                else
                    sudo systemctl disable --now "$srv" >/dev/null 2>&1 || true
                fi
            done

            # Enable the selected service
            if [[ "$scope" == "--user" ]]; then
                if systemctl --user enable --now "$opt"; then ok; else fail; fi
            else
                if sudo systemctl enable --now "$opt"; then ok; else fail; fi
            fi
            break
        else
            error "Invalid option $REPLY"
        fi
    done
}

# ==============================================================================
# 4. CONDITIONAL SYSTEM CONFIGURATION
# ==============================================================================

if_arch() {
    # Check if system is Arch or Arch-based
    if grep -qE "ID=arch|ID_LIKE=arch" /etc/os-release; then
        local message="$1"
        shift
        log_task "$message"

        if "$@" >/dev/null 2>&1; then
            ok
        else
            fail
            return 1
        fi
    else
        return 0
    fi
}

configure_hyprland_services() {
    local IS_HYPRLAND=false
    if [[ "${XDG_SESSION_DESKTOP:-}" == "Hyprland" || -n "${HYPRLAND_INSTANCE_SIGNATURE:-}" ]]; then
        IS_HYPRLAND=true
        header "Configuring Hyprland-specific services"
    fi

    if $IS_HYPRLAND; then
        manage_service "hypridle.service"       "--user" "enable" "Idle daemon"          "Y"
        manage_service "hyprpaper.service"      "--user" "enable" "Wallpaper daemon"     "Y"
        manage_service "pyprland.service"       "--user" "enable" "Pyprland plugins"     "Y"
        manage_service "hyprpolkitagent.service" "--user" "enable" "Polkit Authentication" "Y"
        manage_service "waybar.service"         "--user" "enable" "Status bar"           "Y"
        manage_service "hyprsunset.service"     "--user" "enable" "Blue light filter"    "Y"
    else
        log "Not in Hyprland. Skipping Hyprland-specific services."
    fi
}

run_task() {
    local desc="$1"
    local cmd="$2"

    log_task "$desc"
    
    if eval "$cmd" >/dev/null 2>&1; then
        ok
        return 0
    else
        fail
        return 1
    fi
}
