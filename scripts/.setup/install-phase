#!/usr/bin/env bash
# Note: This file relies on variables and functions defined in the main script.

header "INSTALLATION PHASE"

# Update System
log "Updating system"
if sudo pacman -Syu --noconfirm 2>&1 | grep -v "is up to date"; then
    :
else
    fail
    error "System update failed. Check your internet connection or mirrors."
fi

# Install Rustup
if ! command -v rustup &>/dev/null; then
    log_task "Installing rustup"
    if sudo pacman -S --noconfirm rustup && 
       rustup default stable; then
        ok
    else
        fail
        exit 1
    fi
else
    log_task "Rustup already installed."
    ok
fi

# Install Paru
if ! command -v paru &>/dev/null; then
    log_task "Installing Paru"
    if sudo pacman -S --needed --noconfirm base-devel git &&
       git clone https://aur.archlinux.org/paru.git /tmp/paru &&
       (cd /tmp/paru && makepkg -si --noconfirm) &&
       rm -rf /tmp/paru; then
        ok
    else
        fail
        rm -rf /tmp/paru
        exit 1
    fi
else
    log_task "Paru already installed."
    ok
fi

# Install Official Packages
log "Installing Official Packages..."
sudo pacman -S --needed --noconfirm "${PACMAN_PACKAGES[@]}" 2>&1 | grep -v "is up to date"

# Install AUR Packages
log "Installing AUR Packages..."
paru -S --needed --noconfirm "${AUR_PACKAGES[@]}" 2>&1 | grep -v "is up to date"

# Install Flatpaks
log "Installing Flatpak Apps..."
flatpak remote-add --if-not-exists flathub https://dl.flathub.org/repo/flathub.flatpakrepo
flatpak install -y --noninteractive --or-update flathub "${FLATPAK_APPS[@]}"
