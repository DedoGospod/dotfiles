#!/usr/bin/env bash
# Note: This file relies on variables and functions defined in the main script.

# ==============================================================================
# UI & LOGGING CONFIGURATION
# ==============================================================================

# Colors for logging
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
BLUE='\033[0;34m'
NC='\033[0m'

# Helper Functions
header()  { echo -e "\n${BLUE}==== $1 ====${NC}"; }
log()     { echo -e "${GREEN}[INFO]${NC} $1"; }
warn()    { echo -e "${YELLOW}[WARN]${NC} $1"; }
error()   { echo -e "${RED}[ERROR]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }

log_task() { echo -ne "${GREEN}[INFO]${NC} $1... "; }
ok()       { echo -e "${GREEN}Done.${NC}"; }
fail()     { echo -e "${RED}Failed.${NC}"; }

# ==============================================================================
# PATH & DEPENDENCY MANAGEMENT
# ==============================================================================

# Dynamically find the script directory relative to this file
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

prepare_setup_scripts() {
    header "SYSTEM PREPARATION"

    if [[ -d "$SCRIPT_DIR" ]]; then
        for file in "$SCRIPT_DIR"/*; do
            if [[ -f "$file" ]]; then
                chmod u+x "$file"
            fi
        done
        log_task "Permissions updated for setup scripts"
        ok
    else
        fail
        error "Directory $SCRIPT_DIR not found!"
        exit 1
    fi
}

import_package_list() {
    PACKAGE_LIST="$SCRIPT_DIR/package-list"
    if [[ -f "$PACKAGE_LIST" ]]; then
        # shellcheck source=/dev/null
        source "$PACKAGE_LIST"
        log_task "Package lists loaded."
        ok
    else
        fail
        error "package-list not found!"
        exit 1
    fi
}

import_install_phase() {
    INSTALL_PHASE="$SCRIPT_DIR/install-phase"
    if [[ -f "$INSTALL_PHASE" ]]; then
        # shellcheck source=/dev/null
        source "$INSTALL_PHASE"
    else
        error "install-phase script not found at $INSTALL_PHASE"
        exit 1
    fi
}

# ==============================================================================
# SYSTEM & SECURITY CHECKS
# ==============================================================================

check_if_root() {
    if [[ "$EUID" -eq 0 ]]; then
        error "Please do not run this script as root."
        error "Run it as a normal user. You will be prompted for sudo password when needed."
        exit 1
    fi
}

keep_sudo_alive() {
    # Ask for the password upfront
    sudo -v

    # Update existing sudo time stamp until the script has finished
    while true; do
        sudo -n true
        sleep 60
        # Kill the loop if the parent process (the main script) is no longer running
        kill -0 "$$" || exit
    done 2>/dev/null &
}

# ==============================================================================
# DIRECTORY & ENVIRONMENT SETUP
# ==============================================================================

xdg_setup() {
    header "XDG DIRECTORY SETUP"
    export XDG_DATA_HOME="$HOME/.local/share"
    export XDG_CONFIG_HOME="$HOME/.config"
    export XDG_STATE_HOME="$HOME/.local/state"
    export XDG_CACHE_HOME="$HOME/.cache"

    log_task "Creating directory structure"
    if mkdir -p \
        "$XDG_DATA_HOME" "$XDG_CONFIG_HOME" "$XDG_STATE_HOME" "$XDG_CACHE_HOME" \
        "${XDG_STATE_HOME}/zsh" "${XDG_CACHE_HOME}/zsh" \
        "${XDG_DATA_HOME}/gnupg" "${XDG_STATE_HOME}/python"; then 
        ok
    else 
        fail
    fi
}

# ==============================================================================
# EXECUTION & INTERACTION HELPERS
# ==============================================================================

ask() {
    read -r -p "$(echo -e "  ${YELLOW}??${NC} $1 (y/N): ")" response
    [[ "$response" =~ ^[Yy]$ ]]
}

run_setup_script() {
    local script_name="$1"
    local script_path="$SCRIPT_DIR/$script_name"

    if [[ -f "$script_path" ]]; then
        bash "$script_path"
    else
        error "Could not find $script_name"
    fi
}

is_reboot_required() {
    if [[ -f /tmp/reboot_required ]]; then
        rm /tmp/reboot_required
        if ask "System changes detected. Reboot now?"; then
            log "Rebooting..."
            sudo reboot
        else
            warn "Please reboot manually to apply changes."
        fi
    else
        log "No system changes required a reboot. Enjoy!"
    fi
}
