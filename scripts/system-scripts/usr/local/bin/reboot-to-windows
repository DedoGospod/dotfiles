#!/usr/bin/env bash

LIB_FOLDER="$HOME/.local/lib/snippets/"
# shellcheck source=/dev/null
source "$LIB_FOLDER/logs"

# Ensure the script is running with root privileges
if [[ $EUID -ne 0 ]]; then
   error "This script must be run with sudo or as root."
   exit 1
fi

log "Searching for Windows boot entries..."

# Attempt to find the exact Menu Entry String
WINDOWS_ENTRY=$(grep -iP "menuentry '.*Windows.*'" /boot/grub/grub.cfg | head -n 1 | cut -d"'" -f2)

if [[ -n "$WINDOWS_ENTRY" ]]; then
    log "Found GRUB entry: $WINDOWS_ENTRY"
    grub-reboot "$WINDOWS_ENTRY"
    BOOT_METHOD_LOADED=true
else
    error "Could not find Windows in grub.cfg"
fi

# Fallback/Parallel: Set EFI BootNext (Direct UEFI bypass)
WINDOWS_BOOTNUM=$(efibootmgr | grep -i "Windows Boot Manager" | sed -n 's/Boot\([0-9A-F]\{4\}\).*/\1/p' | head -n 1)

if [[ -n "$WINDOWS_BOOTNUM" ]]; then
    log "Setting EFI BootNext to: $WINDOWS_BOOTNUM"
    efibootmgr --bootnext "$WINDOWS_BOOTNUM" --quiet
    BOOT_METHOD_LOADED=true
else
    error "No Windows UEFI entry found."
fi

# Final Execution
if [[ "$BOOT_METHOD_LOADED" = true ]]; then
    log "Rebooting to Windows now..."
    reboot
else
    error "No Windows boot methods succeeded. Aborting."
    exit 1
fi
