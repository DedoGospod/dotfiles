#!/usr/bin/env bash

# Request sudo upfront
sudo -v

# Import logs
LIB_FOLDER="$HOME/.local/lib/snippets/"
# shellcheck source=/dev/null
source "$LIB_FOLDER/logs"

# Automatically find thew windows index
WINDOWS_INDEX=$(grep -i "^menuentry" /boot/grub/grub.cfg | cut -d"'" -f2 | grep -ni "Windows" | cut -d":" -f1)

# Try grub-reboot first
sudo grub-reboot "$WINDOWS_INDEX" || {
    warn "grub-reboot failed, trying grub-editenv..."
    sudo grub-editenv /boot/grub/grubenv set next_entry="$WINDOWS_INDEX"
}

# Fallback to efibootmgr if GRUB fails
if ! sudo efibootmgr | grep -q "Windows"; then
    warn "No Windows UEFI entry found."
else
    WINDOWS_BOOTNUM=$(sudo efibootmgr | grep "Windows" | sed 's/Boot\([0-9A-F]*\).*/\1/')
    sudo efibootmgr --bootnext "$WINDOWS_BOOTNUM"
fi

# Execution
read -rp "Reboot to Windows now? (y/N): " confirm
if [[ "$confirm" =~ ^[yY] ]]; then
    sudo reboot
else
    log "Staged. Your next manual reboot will go to Windows."
fi
