#!/usr/bin/env bash

# Secure Environment Setup
SECURE_DIR="/run/snapper-hooks"
if [[ ! -d "$SECURE_DIR" ]]; then
    mkdir -p "$SECURE_DIR"
    chmod 700 "$SECURE_DIR"
fi

# Create a unique state file for this specific process
STATE_FILE=$(mktemp -p "$SECURE_DIR" "snapper-pre-${PPID}.XXXXX")

# Configuration & Detection
CRITICAL_PKGS=(
    "linux"
    "systemd"
    "nvidia"
    "mesa"
    "grub"
    "mkinitcpio"
    "glibc"
    "pacman"
    "amd-ucode"
    "intel-ucode"
)

CMD=$(ps -p "$PPID" -o args= || echo "unknown process")
TYPE="routine"

for pkg in "${CRITICAL_PKGS[@]}"; do
    if [[ "$CMD" == *"$pkg"* ]]; then
        TYPE="important"
        break
    fi
done

# Metadata Construction
if [[ "$TYPE" == "important" ]]; then
    DESC="[CRITICAL] $CMD"
    USERDATA="important=yes"
else
    DESC="Routine: $CMD"
    USERDATA=""
fi

# Execution 
SNAPPER_ARGS=(create -t pre -c number -d "$DESC" -p)

# Only add the userdata flag if marked important
if [[ -n "$USERDATA" ]]; then
    SNAPPER_ARGS+=(--userdata "$USERDATA")
fi

# Execute snapper and save the ID to our secure temp file
snapper "${SNAPPER_ARGS[@]}" > "$STATE_FILE"
