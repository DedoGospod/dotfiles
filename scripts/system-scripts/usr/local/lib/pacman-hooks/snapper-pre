#!/usr/bin/env bash

STATE_FILE="/tmp/snapper-num"

# Define your critical packages in an array
CRITICAL_PKGS=(
    "linux"
    "systemd"
    "nvidia"
    "mesa"
    "grub"
    "mkinitcpio"
)

# Capture the parent process command
CMD=$(ps -p "$PPID" -o args= || echo "unknown process")

# Check if any array element exists in the CMD string
for pkg in "${CRITICAL_PKGS[@]}"; do
    if [[ "$CMD" == *"$pkg"* ]]; then
        TYPE="important"
        break
    fi
done

# Determine metadata based on type
if [ "$TYPE" = "important" ]; then
    DESC="[CRITICAL] $CMD"
    USERDATA="important=yes"
else
    DESC="Routine: $CMD"
    USERDATA="important=no"
fi

# Create snapshot and save ID to temp file
snapper create -t pre -c number -d "$DESC" --userdata "${USERDATA:-}" -p > "$STATE_FILE"
