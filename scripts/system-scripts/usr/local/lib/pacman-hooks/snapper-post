#!/usr/bin/env sh

GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

log()   { printf "${GREEN}[INFO]${NC} %s\n" "$1"; }
error() { printf "${RED}[ERROR]${NC} %s\n" "$1"; }

STATE_FILE="/tmp/snapper-num"

# Capture package list and flatten newlines into spaces immediately
FULL_PKGS=$(cat | tr '\n' ' ' | xargs)

# Split into positional parameters to count them
# shellcheck disable=SC2086
set -- $FULL_PKGS
COUNT=$#

# Format the description string
if [ "$COUNT" -gt 5 ]; then
    DESC_PKGS="$1 $2 $3 $4 $5... ($COUNT pkgs)"
elif [ "$COUNT" -gt 0 ]; then
    DESC_PKGS="$FULL_PKGS"
else
    DESC_PKGS="No packages changed"
fi

# If no pre-snapshot state exists, just stop
[ ! -f "$STATE_FILE" ] && exit 0

PRE=$(cat "$STATE_FILE")

# Create the post-snapshot
if POST=$(snapper create -t post --pre-number "$PRE" -c number -d "Packages: $DESC_PKGS" -p); then
    log "Snapshot created: $PRE -> $POST"
    rm "$STATE_FILE"
else
    error "Failed to create post-snapshot" >&2
fi
