#!/usr/bin/env bash

# Use the same secure directory as the Pre-hook
SECURE_DIR="/run/snapper-hooks"

# Match the specific state file for this process ID
STATE_FILE_PATTERN="${SECURE_DIR}/snapper-pre-${PPID}."

# Find the state file
STATE_FILES=("${STATE_FILE_PATTERN}"*)
STATE_FILE="${STATE_FILES[0]}"

GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

log()   { printf "${GREEN}[INFO]${NC} %s\n" "$1"; }
error() { printf "${RED}[ERROR]${NC} %s\n" "$1"; }

# Check if the glob actually matched a real file
if [[ ! -f "$STATE_FILE" ]]; then
    error "No matching Pre-snapshot state file found for PID ${PPID}"
    exit 1
fi

PRE=$(cat "$STATE_FILE")

# Process the Package List from stdin
FULL_PKGS=$(cat | tr -s '[:space:]' ' ' | xargs)
read -ra PKG_ARRAY <<< "$FULL_PKGS"
COUNT=${#PKG_ARRAY[@]}

# Format the Description
if [ "$COUNT" -gt 5 ]; then
    DESC_PKGS="${PKG_ARRAY[0]} ${PKG_ARRAY[1]} ${PKG_ARRAY[2]}... ($COUNT pkgs)"
elif [ "$COUNT" -gt 0 ]; then
    DESC_PKGS="$FULL_PKGS"
else
    DESC_PKGS="No packages changed"
fi

# Create the Post-Snapshot
if POST=$(snapper create -t post --pre-number "$PRE" -c number -d "Post: $DESC_PKGS" -p); then
    log "Snapshot created: $PRE -> $POST"
    rm "$STATE_FILE"
else
    error "Snapper failed to create post-snapshot for Pre ID: $PRE"
    exit 1
fi
